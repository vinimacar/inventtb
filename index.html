<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Invent√°rio de Biblioteca</title>
  <!-- Supabase JS -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- SheetJS (XLS) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF (PDF) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #f7f9fb;
      --card: #fff;
      --muted: #bfc9d9;
      --text: #23272f;
      --accent: #4f8cff;
      --accent2: #00cfc1;
      --danger: #ff3c6a;
      --warn: #f59e0b;
      --shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.07);
      --radius: 14px;
      --glass: #fff;
      --neon: none;
      --font: 'Segoe UI', 'Arial', sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-attachment: fixed;
    }
    .container {
      max-width: 900px;
      margin: 32px auto;
      padding: 0 12px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
    }
    h1 {
      font-size: 28px;
      margin: 0;
      letter-spacing: 1px;
      color: var(--accent);
      font-family: var(--font);
      font-weight: 700;
      background: none;
      text-shadow: none;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px 18px 14px 18px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid #e6eaf1;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .card:hover {
      box-shadow: 0 2px 16px 0 var(--accent2, #e6eaf1);
      border: 1px solid var(--accent2);
    }
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .stack { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    label {
      font-size: 13px;
      color: #6b7a90;
      letter-spacing: 0.5px;
      font-weight: 500;
      text-shadow: none;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      background: #f7f9fb;
      border: 1px solid #e6eaf1;
      border-radius: 8px;
      color: var(--text);
      outline: none;
      font-family: var(--font);
      font-size: 15px;
      box-shadow: none;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.5px solid var(--accent);
      background: #fff;
    }
    input::placeholder, textarea::placeholder {
      color: #bfc9d9;
      opacity: 1;
      font-style: italic;
    }
    button {
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font);
      font-weight: 600;
      font-size: 15px;
      box-shadow: none;
      letter-spacing: 0.5px;
      transition: background 0.2s, color 0.2s;
      outline: none;
    }
    button:hover, button:focus {
      background: var(--accent2);
      color: #fff;
    }
    button.ghost {
      background: transparent;
      border: 1px solid var(--accent2);
      color: var(--accent2);
      box-shadow: none;
    }
    button.ghost:hover {
      background: var(--accent2);
      color: #fff;
    }
    button.warn {
      background: var(--warn);
      color: #fff;
    }
    button.danger {
      background: var(--danger);
      color: #fff;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .toolbar .search { flex: 1 1 280px; display: flex; gap: 10px; align-items: center; }
    .toolbar input { flex: 1; }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: none;
      border: 1px solid #e6eaf1;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #e6eaf1;
      text-align: left;
      font-size: 15px;
    }
    th {
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      background: #f7f9fb;
      text-shadow: none;
    }
    tr:hover {
      background: #f0f6ff;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid var(--accent2);
      color: var(--accent2);
      background: #f7f9fb;
      text-shadow: none;
      font-family: var(--font);
      letter-spacing: 0.5px;
      box-shadow: none;
    }
  .qty-low { color: #ff3c6a; font-weight: bold; }
  .qty-ok { color: var(--accent2); font-weight: bold; }
    .right { text-align: right; }

    .auth, .book-form, .books { margin-bottom: 18px; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.12);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    .modal.open { display: flex; }
    .modal .panel {
      width: 100%;
      max-width: 440px;
      background: #fff;
      border: 1px solid #e6eaf1;
      border-radius: 16px;
      box-shadow: 0 2px 16px 0 #e6eaf1;
      animation: popin 0.2s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes popin {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .panel header {
      padding: 14px 18px;
      border-bottom: 1px solid #e6eaf1;
      color: var(--accent);
      font-size: 17px;
      font-family: var(--font);
      letter-spacing: 0.5px;
      font-weight: 600;
      text-shadow: none;
    }
    .panel main { padding: 18px; }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #fff;
      color: var(--accent2);
      border: 1px solid var(--accent2);
      padding: 12px 18px;
      border-radius: 12px;
      box-shadow: 0 2px 8px 0 #e6eaf1;
      display: none;
      font-family: var(--font);
      font-size: 15px;
      text-shadow: none;
      z-index: 2000;
    }
    .toast.show { display: block; }

    .muted { color: #7f8fa6; }
    .small { font-size: 12px; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    @media (max-width: 760px){
      .grid.cols-3 { grid-template-columns: 1fr; }
      .grid.cols-2 { grid-template-columns: 1fr; }
      header { grid-template-columns: 1fr; }
      .container { padding: 0 4px; }
    }

    pre {
      background: #f7f9fb;
      border: 1px solid #e6eaf1;
      padding: 12px;
      border-radius: 8px;
      overflow:auto;
      color: #6b7a90;
      font-family: 'Fira Mono', 'Consolas', monospace;
      font-size: 13px;
    }
    /* Google Fonts Orbitron */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Invent√°rio de Biblioteca</h1>
      <div class="stack" id="authStatus">
        <span class="badge">Desconectado</span>
        <button class="primary" id="btnOpenAuth">Entrar</button>
      </div>
    </header>

    <details class="card" open>
      <summary><strong>‚öôÔ∏è Passos de Configura√ß√£o (Supabase)</strong></summary>
      <div class="grid" style="margin-top:10px">
        <ol>
          <li>Crie um projeto em <em>app.supabase.com</em>.</li>
          <li>Em <strong>SQL Editor</strong>, rode o script abaixo para criar as tabelas.</li>
          <li>Em <strong>Authentication ‚Üí Providers</strong>, habilite <em>Email</em>.</li>
          <li>Em <strong>Authentication ‚Üí Policies</strong> (ou via SQL), habilite as pol√≠ticas RLS do script.</li>
          <li>Copie <strong>Project URL</strong> e <strong>anon public key</strong> em <em>Project Settings ‚Üí API</em> e cole nos campos abaixo.</li>
          <li>Crie um usu√°rio (signup) e fa√ßa login para usar o app.</li>
        </ol>
        <div>
          <label class="small muted">SQL: Tabelas & Pol√≠ticas (cole no SQL Editor)</label>
          <pre><code>-- Habilite a extens√£o pgcrypto se necess√°rio
-- create extension if not exists pgcrypto;

-- Tabela de livros
create table if not exists public.books (
  id uuid primary key default gen_random_uuid(),
  created_at timestamp with time zone default now(),
  title text not null,
  author text,
  isbn text,
  category text,
  year integer,
  genre text,
  location text,
  notes text,
  quantity integer not null default 1,
  user_id uuid references auth.users(id) not null
);

-- Movimenta√ß√µes (sa√≠da/entrada)
create table if not exists public.movements (
  id uuid primary key default gen_random_uuid(),
  created_at timestamp with time zone default now(),
  book_id uuid references public.books(id) on delete cascade,
  type text check (type in ('checkout','return')) not null,
  qty integer not null check (qty > 0),
  borrower text,
  due_date date,
  returned_at timestamp with time zone,
  user_id uuid references auth.users(id) not null
);

-- RLS
alter table public.books enable row level security;
alter table public.movements enable row level security;

-- Pol√≠ticas simples: qualquer usu√°rio autenticado pode CRUD (ajuste para sua realidade)
create policy "books_read" on public.books for select to authenticated using (true);
create policy "books_insert" on public.books for insert to authenticated with check (auth.uid() = user_id);
create policy "books_update" on public.books for update to authenticated using (auth.uid() = user_id);
create policy "books_delete" on public.books for delete to authenticated using (auth.uid() = user_id);

create policy "mov_read"   on public.movements for select to authenticated using (true);
create policy "mov_insert" on public.movements for insert  to authenticated with check (auth.uid() = user_id);

-- √çndices √∫teis
create index if not exists books_title_idx on public.books using gin (to_tsvector('portuguese', coalesce(title,'') || ' ' || coalesce(author,'')));
create index if not exists books_isbn_idx on public.books (isbn);
</code></pre>
        </div>
      </div>
    </details>

    <section class="card">
      <div class="grid cols-2">
        <div>
          <label>Supabase URL</label>
          <input id="supabaseUrl" placeholder="https://YOUR-PROJECT.supabase.co" value="https://wgdbxprbzjhxmavsqqiw.supabase.co" />
        </div>
        <div>
          <label>Supabase anon key</label>
          <input id="supabaseKey" placeholder="eyJhbGciOi..." value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnZGJ4cHJiempoeG1hdnNxcWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzYwNTYsImV4cCI6MjA3MDc1MjA1Nn0.uqJ9EPR8ij_E2WVtv50uz89-qqz9aOVtA8yzdRjGp-w" />
        </div>
      </div>
      <div class="stack" style="justify-content: flex-end; margin-top:10px">
        <button id="btnConnect" class="primary">Conectar</button>
      </div>
    </section>

    <section class="card auth">
      <form id="authForm" autocomplete="on" onsubmit="return false;">
        <div class="grid cols-3">
          <div>
            <label>Email</label>
            <input id="authEmail" type="email" placeholder="seu@email.com" autocomplete="username" />
          </div>
          <div>
            <label>Senha</label>
            <input id="authPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <div class="stack" style="align-items:flex-end;">
            <button id="btnSignup" type="button">Cadastrar</button>
            <button id="btnLogin" class="primary" type="button">Entrar</button>
            <button id="btnLogout" class="ghost" type="button">Sair</button>
          </div>
        </div>
      </form>
      <p class="small muted" style="margin-top:8px">Dica: cadastre-se primeiro; depois fa√ßa login. A pol√≠tica RLS usa seu <code>user_id</code>.</p>
    </section>

    <section class="card book-form">
      <h3 style="margin-top:0">‚ûï Novo Livro</h3>
      <div class="grid cols-3">
        <div>
          <label>ISBN</label>
          <input id="bkIsbn" placeholder="Ex.: 978-8576081739" />
        </div>
        <div>
          <label>Nome do Livro *</label>
          <input id="bkTitle" placeholder="Ex.: Estruturas de Dados" />
        </div>
        <div>
          <label>Autor *</label>
          <input id="bkAuthor" placeholder="Ex.: Cormen et al." />
        </div>
        <div>
          <label>G√™nero *</label>
          <select id="bkGenre">
            <option value="">Selecione...</option>
            <option value="ACADEMICO">Acad√™mico</option>
            <option value="AUTOAJUDA">Autoajuda</option>
            <option value="AVENTURA">Aventura</option>
            <option value="BIOGRAFIA">Biografia</option>
            <option value="CIENCIAS">Ci√™ncias</option>
            <option value="DIDATICO">Did√°tico</option>
            <option value="DRAMA">Drama</option>
            <option value="EDUCACAO">Educa√ß√£o</option>
            <option value="FANTASIA">Fantasia</option>
            <option value="FICCAO">Fic√ß√£o</option>
            <option value="FICCAO_CIENTIFICA">Fic√ß√£o Cient√≠fica</option>
            <option value="HISTORIA">Hist√≥ria</option>
            <option value="INFANTIL">Infantil</option>
            <option value="JUVENIL">Juvenil</option>
            <option value="LITERATURA">Literatura</option>
            <option value="MISTERIO">Mist√©rio</option>
            <option value="NAO_FICCAO">N√£o Fic√ß√£o</option>
            <option value="OUTROS">Outros</option>
            <option value="POESIA">Poesia</option>
            <option value="ROMANCE">Romance</option>
            <option value="TECNOLOGIA">Tecnologia</option>
            <option value="TECNICO">T√©cnico</option>
            <option value="TERROR">Terror</option>
          </select>
        </div>
        <div>
          <label>Quantidade *</label>
          <input id="bkQty" type="number" min="0" value="1" />
        </div>
        <div>
          <label>Ano de Publica√ß√£o</label>
          <input id="bkYear" type="number" min="0" max="2100" placeholder="Ex.: 2020" />
        </div>
        <div>
          <label>Editora</label>
          <input id="bkPublisher" placeholder="Ex.: Editora Exemplo" />
        </div>
        <div class="grid" style="grid-column: 1 / -1;">
          <label>Notas</label>
          <textarea id="bkNotes" rows="2" placeholder="Observa√ß√µes..."></textarea>
        </div>
      </div>
      <div class="stack" style="justify-content:flex-end; margin-top:10px">
        <button id="btnAdd" class="primary">Adicionar</button>
        <button id="btnClear" class="ghost">Limpar</button>
      </div>
    </section>

    <section class="card books">
      <div class="toolbar">
        <div class="search">
          <input id="search" placeholder="Buscar por t√≠tulo/autor/ISBN..." />
        </div>
        <div class="stack">
          <span class="badge" id="totalBadge">0 itens</span>
          <button id="btnRefresh" class="ghost">Atualizar</button>
          <button id="export-xls" class="ghost">Exportar XLS</button>
          <button id="export-pdf" class="ghost">Exportar PDF</button>
        </div>
      </div>
      <table id="tblBooks">
        <thead>
          <tr>
            <th data-sort="isbn">ISBN</th>
            <th data-sort="title">Nome do Livro</th>
            <th data-sort="author">Autor</th>
            <th>G√™nero</th>
            <th class="right" data-sort="quantity">Quantidade</th>
            <th data-sort="year">Ano de Publica√ß√£o</th>
            <th>Editora</th>
            <th>Colaborador</th>
            <th class="right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <div class="modal" id="modalEdit">
      <div class="panel">
        <header><strong>Editar Livro</strong></header>
        <main>
          <div class="grid cols-2">
            <div>
              <label>ISBN</label>
              <input id="edIsbn" />
            </div>
            <div>
              <label>T√≠tulo</label>
              <input id="edTitle" />
            </div>
            <div>
              <label>Autor</label>
              <input id="edAuthor" />
            </div>
            <div>
              <label>Ano de Publica√ß√£o</label>
              <input id="edYear" type="number" min="0" max="2100" />
            </div>
            <div>
              <label>G√™nero</label>
              <select id="edGenre">
                <option value="">Selecione...</option>
                <option value="ACADEMICO">Acad√™mico</option>
                <option value="AUTOAJUDA">Autoajuda</option>
                <option value="AVENTURA">Aventura</option>
                <option value="BIOGRAFIA">Biografia</option>
                <option value="CIENCIAS">Ci√™ncias</option>
                <option value="DIDATICO">Did√°tico</option>
                <option value="DRAMA">Drama</option>
                <option value="EDUCACAO">Educa√ß√£o</option>
                <option value="FANTASIA">Fantasia</option>
                <option value="FICCAO">Fic√ß√£o</option>
                <option value="FICCAO_CIENTIFICA">Fic√ß√£o Cient√≠fica</option>
                <option value="HISTORIA">Hist√≥ria</option>
                <option value="INFANTIL">Infantil</option>
                <option value="JUVENIL">Juvenil</option>
                <option value="LITERATURA">Literatura</option>
                <option value="MISTERIO">Mist√©rio</option>
                <option value="NAO_FICCAO">N√£o Fic√ß√£o</option>
                <option value="OUTROS">Outros</option>
                <option value="POESIA">Poesia</option>
                <option value="ROMANCE">Romance</option>
                <option value="TECNOLOGIA">Tecnologia</option>
                <option value="TECNICO">T√©cnico</option>
                <option value="TERROR">Terror</option>
              </select>
            </div>
            <div>
              <label>Quantidade *</label>
              <input id="edQty" type="number" min="0" value="1" />
            </div>
            <div>
              <label>Editora</label>
              <input id="edPublisher" placeholder="Ex.: Editora Exemplo" />
            </div>
          </div>
          <div class="grid" style="grid-column: 1 / -1;">
            <label>Notas</label>
            <textarea id="edNotes" rows="2" placeholder="Observa√ß√µes..."></textarea>
          </div>
          <div class="stack" style="justify-content:flex-end; margin-top:10px">
            <button id="btnSaveEdit" class="primary">Salvar</button>
            <button id="btnCancelEdit" class="ghost">Cancelar</button>
          </div>
        </main>
      </div>
    </div>

    <div class="modal" id="modalMove">
      <div class="panel">
        <header><strong id="mvTitle">Registrar Sa√≠da</strong></header>
        <main>
          <div class="grid cols-2">
            <div>
              <label>Quantidade</label>
              <input id="mvQty" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Leitor (opcional)</label>
              <input id="mvBorrower" placeholder="Nome do leitor" />
            </div>
            <div>
              <label>Devolver at√© (opcional)</label>
              <input id="mvDue" type="date" />
            </div>
          </div>
          <div class="stack" style="justify-content:flex-end; margin-top:10px">
            <button id="btnConfirmMove" class="primary">Confirmar</button>
            <button id="btnCancelMove" class="ghost">Cancelar</button>
          </div>
        </main>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    // Prote√ß√£o contra interfer√™ncia de extens√µes
    (function() {
      'use strict';
      
      // Vari√°veis isoladas no escopo
      let supabaseClient = null;
      let session = null;
      let booksCache = [];
      let currentEditId = null;
      let currentMove = { type: 'checkout', book: null };
      let sortState = { field: 'created_at', dir: 'desc' };

    const el = sel => {
      try {
        const element = document.querySelector(sel);
        if (!element) {
          console.warn(`Element not found: ${sel}`);
          return { value: '', textContent: '', classList: { add: () => {}, remove: () => {} } };
        }
        return element;
      } catch (e) {
        console.error(`Error selecting element ${sel}:`, e);
        return { value: '', textContent: '', classList: { add: () => {}, remove: () => {} } };
      }
    };
    const els = sel => {
      try {
        return [...document.querySelectorAll(sel)];
      } catch (e) {
        console.error(`Error selecting elements ${sel}:`, e);
        return [];
      }
    };
    const toast = (msg) => { const t = el('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 2400); };

    function ensureClient(){
      if (supabaseClient) return supabaseClient;
      const url = el('#supabaseUrl').value.trim();
      const key = el('#supabaseKey').value.trim();
      if(!url || !key){ toast('Informe URL e anon key do Supabase.'); throw new Error('Missing supabase creds'); }
      supabaseClient = window.supabase.createClient(url, key);
      return supabaseClient;
    }

    function setAuthUI(){
      const status = el('#authStatus');
      status.innerHTML = '';
      if(session && session.user){
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = `Conectado: ${session.user.email}`;
        const btn = document.createElement('button');
        btn.textContent = 'Sair';
        btn.className = 'ghost';
        btn.onclick = logout;
        status.append(span, btn);
      } else {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = 'Desconectado';
        const btn = document.createElement('button');
        btn.textContent = 'Entrar';
        btn.className = 'primary';
        btn.onclick = () => el('#authEmail').focus();
        status.append(span, btn);
      }
    }

    async function connect(){
      try {
        ensureClient();
        const { data } = await supabaseClient.auth.getSession();
        session = data.session;
        setAuthUI();
        listenAuth();
        if(session){ await loadBooks(); subscribeBooks(); }
        toast('Conex√£o OK.');
      } catch(e){ console.error(e); }
    }

    function listenAuth(){
      supabaseClient.auth.onAuthStateChange((_event, s) => {
        session = s?.session ?? s; 
        setAuthUI();
        if(session){ loadBooks(); subscribeBooks(); }
        else { booksCache = []; renderBooks(); }
      });
    }

    async function signup(){
      ensureClient();
      const email = el('#authEmail').value.trim();
      const password = el('#authPassword').value;
      if(!email || !password) return toast('Preencha email e senha.');
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if(error) return toast(error.message);
      toast('Cadastro realizado. Verifique seu email (se exigido).');
    }

    async function login(){
      ensureClient();
      const email = el('#authEmail').value.trim();
      const password = el('#authPassword').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error) return toast(error.message);
      session = data.session;
      setAuthUI();
      await loadBooks();
      subscribeBooks();
    }
// Busca dados do ISBN na API da Biblioteca Nacional
    async function fetchBookByISBN(isbn) {
      if (!isbn) return null;
      const cleanIsbn = isbn.replace(/[^0-9Xx]/g, '');
      if (cleanIsbn.length < 10) return null;
      // Remova ou comente este bloco para evitar o erro:
      // try {
      //   const resp = await fetch(`https://servicos.bn.gov.br/api/consulta/isbn/${cleanIsbn}`);
      //   if (resp.ok) {
      //     const data = await resp.json();
      //     if (Array.isArray(data) && data.length > 0) {
      //       return {
      //         titulo: data[0].titulo,
      //         autor: data[0].autor,
      //         ano: data[0].ano
      //       };
      //     }
      //   }
      // } catch (e) { /* ignora erro */ }
      // Fallback: Open Library
      try {
        const resp2 = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${cleanIsbn}&format=json&jscmd=data`);
        if (resp2.ok) {
          const data2 = await resp2.json();
          const bookData = data2[`ISBN:${cleanIsbn}`];
          if (bookData) {
            return {
              titulo: bookData.title || '',
              autor: bookData.authors ? bookData.authors.map(a => a.name).join('; ') : '',
              ano: bookData.publish_date ? (bookData.publish_date.match(/\d{4}/)?.[0] || '') : ''
            };
          }
        }
      } catch (e) { /* ignora erro */ }
      return null;
    }

    // Organiza a busca e preenchimento de campos pelo ISBN
    async function checkISBNApi(isbn) {
      if (!isbn) return;
      const livro = await fetchBookByISBN(isbn);
      if (livro) {
        toast('ISBN j√° cadastrado na Biblioteca Nacional!');
        if (livro.titulo) el('#bkTitle').value = livro.titulo;
        if (livro.autor) el('#bkAuthor').value = Array.isArray(livro.autor) ? livro.autor.join('; ') : livro.autor;
        if (livro.ano) el('#bkYear').value = livro.ano;
      }
    }
    async function logout(){
      ensureClient();
      await supabaseClient.auth.signOut();
      session = null;
      setAuthUI();
      booksCache = []; renderBooks();
    }

    async function loadBooks(){
      ensureClient();
      const { data, error } = await supabaseClient
        .from('books')
        .select('*')
        .order(sortState.field, { ascending: sortState.dir === 'asc' });
      if(error){ console.error(error); toast(error.message); return; }
      booksCache = data || [];
      renderBooks();
    }

    function subscribeBooks(){
      try{
        supabaseClient.channel('books-changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'books' }, () => loadBooks())
          .subscribe();
      } catch(e){ console.warn('Realtime unavailable', e); }
    }

    function renderBooks(){
      try {
        const q = el('#search').value?.toLowerCase() || '';
        const tbody = el('#tblBooks tbody');
        if (!tbody || typeof tbody.innerHTML === 'undefined') {
          console.error('Table tbody not found or invalid');
          return;
        }
        
        tbody.innerHTML = '';
        const rows = booksCache.filter(b => (
          `${b.title} ${b.author||''} ${b.isbn||''} ${b.year||''} ${b.genre||b.category||''}`.toLowerCase().includes(q)
        ));
        
        const totalBadge = el('#totalBadge');
        if (totalBadge) {
          totalBadge.textContent = `${rows.length} itens`;
        }
        
        for(const b of rows){
          const tr = document.createElement('tr');
          const qtyClass = b.quantity <= 1 ? 'qty-low' : 'qty-ok';
          let colaborador = '‚Äî';
          if (b.user_id && session && session.user && b.user_id === session.user.id) {
            colaborador = session.user.email;
          } else if (b.user_email) {
            colaborador = b.user_email;
          }
          // Use sempre 'genre' (em ingl√™s)
          let actionButtons = `
            <button title="Editar" onclick='openEdit(${JSON.stringify(b)})'>‚úèÔ∏è</button>
            <button title="Excluir" class="danger" onclick='delBook("${b.id}")'>üóëÔ∏è</button>
          `;
          tr.innerHTML = `
            <td>${escapeHtml(b.isbn||'‚Äî')}</td>
            <td>${escapeHtml(b.title)}</td>
            <td>${escapeHtml(b.author||'‚Äî')}</td>
            <td>${escapeHtml(b.year||'‚Äî')}</td>
            <td>${escapeHtml(b.genre||b.category||'‚Äî')}</td>
            <td class="right ${qtyClass}">${b.quantity}</td>
            <td>${escapeHtml(colaborador)}</td>
            <td class="right">${actionButtons}</td>`;
          tbody.appendChild(tr);
        }
      } catch (error) {
        console.error('Error in renderBooks:', error);
        toast('Erro ao renderizar a lista de livros');
      }
    }

    function escapeHtml(str){ return (str+"").replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m])); }

    async function addBook(){
      ensureClient();
      if(!session){ return toast('Fa√ßa login primeiro.'); }
      const title = el('#bkTitle').value.trim();
      const isbn = el('#bkIsbn').value.trim() || null;
      const author = el('#bkAuthor').value.trim() || null;
      const year = el('#bkYear').value ? parseInt(el('#bkYear').value, 10) : null;
      const genre = el('#bkGenre').value || null;
      const publisher = el('#bkPublisher').value.trim() || null;
      const notes = el('#bkNotes').value.trim() || null;
      const qtyValue = el('#bkQty').value;
      let quantity = qtyValue === '' ? 1 : parseInt(qtyValue, 10);

      // Valida√ß√µes refor√ßadas
      if(!title) return toast('Informe o t√≠tulo.');
      if(isNaN(quantity) || quantity < 0) return toast('Quantidade inv√°lida.');
      if(!session.user?.id) return toast('Usu√°rio n√£o autenticado.');

      // Garante que todos os campos obrigat√≥rios estejam presentes
      const book = {
        title,
        quantity,
        user_id: session.user.id
      };
      // Campos opcionais
      if(isbn) book.isbn = isbn;
      if(author) book.author = author;
      if(year) book.year = year;
      if(genre) book.genre = genre;
      if(publisher) book.publisher = publisher;
      if(notes) book.notes = notes;

      try {
        const { error } = await supabaseClient.from('books').insert(book);
        if(error) {
          if(error.message && error.message.includes('user_id')) {
            return toast('Erro: usu√°rio n√£o autenticado ou user_id inv√°lido. Fa√ßa login novamente.');
          }
          if(error.message && error.message.includes('title')) {
            return toast('Erro: t√≠tulo √© obrigat√≥rio.');
          }
          return toast('Erro ao adicionar livro: ' + error.message);
        }
        toast('Livro adicionado.');
        clearForm();
        await loadBooks();
      } catch (e) {
        toast('Erro inesperado ao adicionar livro.');
        console.error(e);
      }
    }

    function clearForm(){
  ['#bkTitle','#bkAuthor','#bkIsbn','#bkYear','#bkNotes'].forEach(s => el(s).value = '');
  el('#bkGenre').value = '';
  el('#bkQty').value = 1;
    }

    function openEdit(book){
      ensureClient();
      if(!session){ return toast('Fa√ßa login primeiro.'); }
      // Verificar se o usu√°rio √© o dono do livro
      if(book.user_id !== session.user.id){ 
        return toast('Voc√™ s√≥ pode editar seus pr√≥prios livros.'); 
      }
  currentEditId = book.id;
  el('#edIsbn').value = book.isbn || '';
  el('#edTitle').value = book.title || '';
  el('#edAuthor').value = book.author || '';
  el('#edYear').value = book.year || '';
  el('#edGenre').value = book.genre || book.category || '';
  el('#edQty').value = book.quantity || 0;
  el('#edNotes').value = book.notes || '';
  el('#edPublisher').value = book.publisher || '';
  el('#modalEdit').classList.add('open');
    }

    function renderBooks(){
      try {
        const q = el('#search').value?.toLowerCase() || '';
        const tbody = el('#tblBooks tbody');
        if (!tbody || typeof tbody.innerHTML === 'undefined') {
          console.error('Table tbody not found or invalid');
          return;
        }
        
        tbody.innerHTML = '';
        const rows = booksCache.filter(b => (
          `${b.title} ${b.author||''} ${b.isbn||''} ${b.year||''} ${b.genre||b.category||''} ${b.publisher||''}`.toLowerCase().includes(q)
        ));
        
        const totalBadge = el('#totalBadge');
        if (totalBadge) {
          totalBadge.textContent = `${rows.length} itens`;
        }
        
        for(const b of rows){
          const tr = document.createElement('tr');
          const qtyClass = b.quantity <= 1 ? 'qty-low' : 'qty-ok';
          let colaborador = '‚Äî';
          if (b.user_id && session && session.user && b.user_id === session.user.id) {
            colaborador = session.user.email;
          } else if (b.user_email) {
            colaborador = b.user_email;
          }
          // Use sempre 'genre' (em ingl√™s)
          let actionButtons = `
            <button title="Editar" onclick='openEdit(${JSON.stringify(b)})'>‚úèÔ∏è</button>
            <button title="Excluir" class="danger" onclick='delBook("${b.id}")'>üóëÔ∏è</button>
          `;
          tr.innerHTML = `
            <td>${escapeHtml(b.isbn||'‚Äî')}</td>
            <td>${escapeHtml(b.title)}</td>
            <td>${escapeHtml(b.author||'‚Äî')}</td>
            <td>${escapeHtml(b.genre||b.category||'‚Äî')}</td>
            <td class="right ${qtyClass}">${b.quantity}</td>
            <td>${escapeHtml(b.year||'‚Äî')}</td>
            <td>${escapeHtml(b.publisher||'‚Äî')}</td>
            <td>${escapeHtml(colaborador)}</td>
            <td class="right">${actionButtons}</td>`;
          tbody.appendChild(tr);
        }
      } catch (error) {
        console.error('Error in renderBooks:', error);
        toast('Erro ao renderizar a lista de livros');
      }
    }

    // Fun√ß√£o confirmMove corrigida (o bloco estava fora de fun√ß√£o)
    async function confirmMove() {
      ensureClient();
      if (!session) return toast('Fa√ßa login primeiro.');
      if (!currentMove.book) return toast('Nenhum livro selecionado.');
      const qty = parseInt(el('#mvQty').value, 10);
      if (isNaN(qty) || qty < 1) return toast('Quantidade inv√°lida.');
      const borrower = el('#mvBorrower').value.trim() || null;
      const due = el('#mvDue').value ? new Date(el('#mvDue').value).toISOString().slice(0,10) : null;

      const { data: books, error: e1 } = await supabaseClient.from('books').select('id, quantity').eq('id', currentMove.book.id).limit(1);
      if(e1) return toast(e1.message);
      const book = books?.[0];
      if(!book) return toast('Livro n√£o encontrado.');

      let newQty = book.quantity;
      if(currentMove.type === 'checkout'){
        if(qty > book.quantity) return toast('Qtd solicitada maior que o estoque.');
        newQty = book.quantity - qty;
      } else {
        newQty = book.quantity + qty;
      }

      const movement = { book_id: book.id, type: currentMove.type, qty, borrower, due_date: due, user_id: session.user.id };
      const { error: e2 } = await supabaseClient.from('movements').insert(movement);
      if(e2) return toast(e2.message);

      const { error: e3 } = await supabaseClient.from('books').update({ quantity: newQty }).eq('id', book.id);
      if(e3) return toast(e3.message);

      toast(currentMove.type === 'checkout' ? 'Sa√≠da registrada.' : 'Devolu√ß√£o registrada.');
      el('#modalMove').classList.remove('open');
      await loadBooks();
    }

    function sortBy(field){
      if(sortState.field === field){ sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; }
      else { sortState.field = field; sortState.dir = 'asc'; }
      loadBooks();
    }

    // ===== EXPORTA√á√ïES =====
    function getFilteredRows(){
      const q = el('#search').value?.toLowerCase() || '';
      return booksCache.filter(b => (`${b.title} ${b.author||''} ${b.isbn||''}`.toLowerCase().includes(q)));
    }

    function exportXLS(){
      const rows = getFilteredRows();
      const data = rows.map(b => ({
        ISBN: b.isbn || '',
        'Nome do Livro': b.title,
        Autor: b.author || '',
        G√™nero: b.genre || '',
        Quantidade: b.quantity,
        'Ano de Publica√ß√£o': b.year || '',
        Editora: b.publisher || '', // <-- already included
        Colaborador: (b.user_id && session && session.user && b.user_id === session.user.id) ? session.user.email : (b.user_email || '‚Äî'),
        Criado_em: b.created_at?.slice(0,10) || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
      XLSX.writeFile(wb, 'inventario_biblioteca.xlsx');
    }

    function exportPDF(){
      const rows = getFilteredRows();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 40;
      doc.setFontSize(16);
      doc.text('Invent√°rio da Biblioteca', margin, 40);
      const head = [['ISBN','Nome do Livro','Autor','G√™nero','Quantidade','Ano de Publica√ß√£o','Editora','Colaborador']];
      const body = rows.map(b => [
        b.isbn||'',
        b.title,
        b.author||'',
        b.genre||'',
        String(b.quantity),
        b.year||'',
        b.publisher||'',
        (b.user_id && session && session.user && b.user_id === session.user.id) ? session.user.email : (b.user_email || '‚Äî')
      ]);
      if(doc.autoTable){
        doc.autoTable({
          head, body, startY: 60, styles: { fontSize: 9 }, headStyles: { fillColor: [34,197,94] }, margin: { left: margin, right: margin }
        });
      } else {
        // fallback simples
        let y = 60; doc.setFontSize(10);
        body.forEach(r => { doc.text(r.join(' | '), margin, y); y += 14; if(y > 780){ doc.addPage(); y = 40; } });
      }
      doc.save('inventario_biblioteca.pdf');
    }

    // Event bindings
    document.addEventListener('DOMContentLoaded', function() {
      // Aguarda o DOM estar completamente carregado
      setTimeout(function() {
        try {
          // Inicializa√ß√£o segura dos event listeners
          const searchInput = el('#search');
          if (searchInput && typeof searchInput.addEventListener === 'function') {
            searchInput.addEventListener('input', debounce(renderBooks, 150));
          }
          
          const sortHeaders = els('th[data-sort]');
          sortHeaders.forEach(th => {
            if (th && typeof th.addEventListener === 'function') {
              th.addEventListener('click', () => sortBy(th.dataset.sort));
            }
          });
          
          // Busca ISBN ao digitar
          const isbnInput = el('#bkIsbn');
          if (isbnInput && typeof isbnInput.addEventListener === 'function') {
            isbnInput.addEventListener('blur', (e) => {
              checkISBNApi(e.target.value);
            });
          }
        } catch (error) {
          console.error('Error initializing event listeners:', error);
        }
      }, 100);
    });

    document.addEventListener('click', (e) => {
      try {
      if(e.target.closest('#btnConnect')) connect();
      if(e.target.closest('#btnSignup')) signup();
      if(e.target.closest('#btnLogin')) login();
      if(e.target.closest('#btnLogout')) logout();
      if(e.target.closest('#btnAdd')) addBook();
      if(e.target.closest('#btnClear')) clearForm();
      if(e.target.closest('#btnRefresh')) loadBooks();
      if(e.target.closest('#btnSaveEdit')) saveEdit();
      if(e.target.closest('#btnCancelEdit')) el('#modalEdit').classList.remove('open');
      if(e.target.closest('#btnConfirmMove')) confirmMove();
      if(e.target.closest('#btnCancelMove')) el('#modalMove').classList.remove('open');
      if(e.target.closest('#export-xls')) exportXLS();
      if(e.target.closest('#export-pdf')) exportPDF();
      } catch (error) {
        console.error('Error handling click event:', error);
      }
    });

    el('#search').addEventListener('input', debounce(renderBooks, 150));
    els('th[data-sort]').forEach(th => th.addEventListener('click', () => sortBy(th.dataset.sort)));

    // Busca ISBN ao digitar
    el('#bkIsbn').addEventListener('blur', (e) => {
      checkISBNApi(e.target.value);
    });

    function debounce(fn, ms){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), ms); } }

    // Fun√ß√£o para salvar edi√ß√£o de livro
    async function saveEdit() {
      ensureClient();
      if (!session) return toast('Fa√ßa login primeiro.');
      if (!currentEditId) return toast('Nenhum livro selecionado para edi√ß√£o.');
      const title = el('#edTitle').value.trim();
      const isbn = el('#edIsbn').value.trim() || null;
      const author = el('#edAuthor').value.trim() || null;
      const year = el('#edYear').value ? parseInt(el('#edYear').value, 10) : null;
      const genre = el('#edGenre').value || null;
      const qtyValue = el('#edQty').value;
      let quantity = qtyValue === '' ? 1 : parseInt(qtyValue, 10);
  const notes = el('#edNotes').value.trim() || null;
  // Editora do modal de edi√ß√£o
  const publisher = el('#edPublisher') && el('#edPublisher').value ? el('#edPublisher').value.trim() : null;

      if (!title) return toast('Informe o t√≠tulo.');
      if (isNaN(quantity) || quantity < 0) return toast('Quantidade inv√°lida.');

      // Monta objeto de atualiza√ß√£o
      const update = { title, quantity };
      if (isbn) update.isbn = isbn;
      if (author) update.author = author;
      if (year) update.year = year;
      if (genre) update.genre = genre;
      if (notes) update.notes = notes;
      if (publisher !== undefined) update.publisher = publisher;

      try {
        const { error } = await supabaseClient.from('books').update(update).eq('id', currentEditId);
        if (error) return toast('Erro ao salvar edi√ß√£o: ' + error.message);
        toast('Livro atualizado.');
        el('#modalEdit').classList.remove('open');
        await loadBooks();
        currentEditId = null;
      } catch (e) {
        toast('Erro inesperado ao salvar edi√ß√£o.');
        console.error(e);
      }
    }

    // Fun√ß√£o para abrir o modal de movimenta√ß√£o (sa√≠da/entrada)
    function openMove(book) {
      ensureClient();
      if (!session) return toast('Fa√ßa login primeiro.');
      if (!book || !book.id) return toast('Livro inv√°lido.');
      currentMove = { type: 'checkout', book };
      el('#mvQty').value = 1;
      el('#mvBorrower').value = '';
      el('#mvDue').value = '';
      el('#mvTitle').textContent = `Registrar Sa√≠da: ${book.title}`;
      el('#modalMove').classList.add('open');
    }

    // Expor fun√ß√µes globais necess√°rias

    // Expor fun√ß√µes globais necess√°rias
    window.openEdit = openEdit;
    window.openMove = openMove;

    // Fun√ß√£o para excluir livro
    async function delBook(id) {
      ensureClient();
      if (!session) return toast('Fa√ßa login primeiro.');
      if (!id) return toast('ID do livro inv√°lido.');
      const book = booksCache.find(b => b.id === id);
      if (!book) return toast('Livro n√£o encontrado.');
      if (book.user_id !== session.user.id) return toast('Voc√™ s√≥ pode excluir seus pr√≥prios livros.');
      if (!confirm(`Tem certeza que deseja excluir o livro "${book.title}"?`)) return;
      try {
        const { error } = await supabaseClient.from('books').delete().eq('id', id);
        if (error) return toast('Erro ao excluir: ' + error.message);
        toast('Livro exclu√≠do.');
        await loadBooks();
      } catch (e) {
        toast('Erro inesperado ao excluir livro.');
        console.error(e);
      }
    }
    window.delBook = delBook;
    
    })(); // Fim do escopo isolado
  </script>
</body>
</html>


